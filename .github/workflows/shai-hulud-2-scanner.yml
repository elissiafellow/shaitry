name: Shai-Hulud 2 Scanner

on:
  workflow_call:
    inputs:
      strip_private_deps:
        description: 'Remove private git dependencies before npm install'
        required: false
        type: boolean
        default: false
      node_version:
        description: 'Node.js version to use for this repo'
        required: true
        type: string
      npm_version:
        description: 'npm version (optional)'
        required: false
        type: string
        default: ''
      scan_target:
        description: 'Directory to scan for Shai-Hulud 2 indicators'
        required: false
        type: string
        default: '.'
      fail_on:
        description: 'Severity level to fail on (critical, high, medium, low)'
        required: false
        type: string
        default: 'critical'

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}

      - name: Setup npm (if required)
        if: inputs.npm_version != ''
        run: |
          npm install -g npm@${{ inputs.npm_version }}
          npm -v

      - name: Install dependencies (optional private dep removal)
        run: |
          DIR="${{ inputs.scan_target }}"
          echo "Installing dependencies in $DIR"
          cd "$DIR"
          if [ "${{ inputs.strip_private_deps }}" = "true" ] && [ -f package.json ]; then
            jq 'del(.devDependencies["mf-ni-wrapper"]) |
                del(.devDependencies["com.adjust.sdk"])' \
              package.json > temp.package.json
            mv package.json original.package.json
            mv temp.package.json package.json
          fi
          npm install --ignore-scripts --no-audit --no-fund
          if [ "${{ inputs.strip_private_deps }}" = "true" ] && [ -f original.package.json ]; then
            mv original.package.json package.json
          fi
          cd -

      - name: Run Shai-Hulud Supply Chain Scanner
        id: scan
        run: |
          set -euo pipefail
          WORK_DIR="${{ github.workspace }}"
          SCAN_TARGET="${{ inputs.scan_target }}"
          SCAN_WORKDIR="$WORK_DIR/npm-scanner"

          echo "üì¶ Scanning directory: $SCAN_TARGET"
          echo "Workdir: $SCAN_WORKDIR"
          echo "Fail on: ${{ inputs.fail_on }}"

          mkdir -p "$SCAN_WORKDIR"
          cd "$SCAN_WORKDIR"

          echo "üì• Cloning scanner repository"
          git clone --depth 1 https://github.com/elissiafellow/shai-hulud-2-scanner.git .

          if [ ! -f "scan.js" ]; then
            echo "‚ùå Scanner file 'scan.js' not found"
            exit 1
          fi

          SCAN_OUTPUT_FILE="$WORK_DIR/scan-results-$(echo "$SCAN_TARGET" | tr '/.' '__').txt"

          if node scan.js "$WORK_DIR/$SCAN_TARGET" --deep --fail-on=${{ inputs.fail_on }} > "$SCAN_OUTPUT_FILE" 2>&1; then
            SCAN_EXIT=0
          else
            SCAN_EXIT=$?
          fi

          echo ""
          echo "=== Scan Results ==="
          cat "$SCAN_OUTPUT_FILE"
          echo "===================="

          if [ -f "shai-hulud-report.csv" ]; then
            cp "shai-hulud-report.csv" "$WORK_DIR/" || echo "‚ö†Ô∏è Could not copy CSV report"
            echo "üìÑ CSV report available"
          fi

          echo "SCAN_EXIT_CODE=$SCAN_EXIT" >> $GITHUB_OUTPUT
          echo "SCAN_RESULTS_FILE=$SCAN_OUTPUT_FILE" >> $GITHUB_OUTPUT

          cd "$WORK_DIR"
          rm -rf "$SCAN_WORKDIR"

          if [ $SCAN_EXIT -ne 0 ]; then
            echo "‚ùå Scanner found issues (exit code: $SCAN_EXIT)"
          else
            echo "‚úÖ Scanner passed - no ${{ inputs.fail_on }} issues found"
          fi
          exit $SCAN_EXIT

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shai-hulud-scan-results-${{ github.run_id }}-${{ inputs.scan_target }}
          path: |
            scan-results-*.txt
            shai-hulud-report-*.csv