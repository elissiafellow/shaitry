name: Shai-Hulud 2 Scanner

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number (for commenting)'
        required: false
        type: number
      strip_private_deps:
        description: 'Remove private git dependencies before npm install'
        required: false
        type: boolean
        default: false
      node_version:
        description: 'Node.js version to use for this repo'
        required: true
        type: string
      npm_version:
        description: 'npm version (optional)'
        required: false
        type: string
        default: ''
      scan_target:
        description: 'Comma-separated directories to scan (each must contain package.json)'
        required: false
        type: string
        default: ''
      fail_on:
        description: 'Severity level to fail on (critical, high, medium, low)'
        required: false
        type: string
        default: 'critical'
   

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Modify package.json (remove private deps)
        if: inputs.strip_private_deps
        run: |
          jq 'del(.devDependencies["mf-ni-wrapper"]) |
              del(.devDependencies["com.adjust.sdk"])' \
            package.json > temp.package.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}

      - name: Verify Node version
        run: |
          echo "Using Node $(node -v)"
          echo "Using npm $(npm -v)"

      - name: Setup npm (if required)
        if: inputs.npm_version != ''
        run: |
          npm install -g npm@${{ inputs.npm_version }}
          npm -v


      # - name: Cache scanner
      #   uses: actions/cache@v3
      #   id: scanner-cache
      #   with:
      #     path: ~/.cache/shai-hulud-scanner
      #     key: shai-hulud-scanner
      #     restore-keys: |
      #       shai-hulud-scanner-

      # - name: Install dependencies with npm
      #   run: npm install
      - name: Install dependencies
        run: |
          if [ "${{ inputs.strip_private_deps }}" = "true" ]; then
            mv package.json original.package.json
            mv temp.package.json package.json
          fi

          npm install

          if [ "${{ inputs.strip_private_deps }}" = "true" ]; then
            mv original.package.json package.json
          fi

      - name: Run Shai-Hulud Supply Chain Scanner
        id: scan
        run: |
          set -euo pipefail
      
          WORK_DIR="${{ github.workspace }}"
          SCAN_TARGETS="${{ inputs.scan_target }}"
          SCAN_WORKDIR="$WORK_DIR/npm-scanner"
      
          echo "üì¶ Shai-Hulud 2 Scan"
          echo "Targets: ${SCAN_TARGETS:-.}"
          echo "Fail on: ${{ inputs.fail_on }}"
          echo "Workdir: $SCAN_WORKDIR"
          echo "--------------------------------"
      
          # Default to repo root if nothing passed
          if [ -z "$SCAN_TARGETS" ]; then
            SCAN_TARGETS="."
          fi
      
          # Prepare scanner
          rm -rf "$SCAN_WORKDIR"
          mkdir -p "$SCAN_WORKDIR"
          cd "$SCAN_WORKDIR"
      
          echo "üì• Cloning scanner repository"
          git clone --depth 1 https://github.com/elissiafellow/shai-hulud-2-scanner.git .
      
          if [ ! -f "scan.js" ]; then
            echo "‚ùå scan.js not found"
            exit 1
          fi
      
          IFS=',' read -ra DIRS <<< "$SCAN_TARGETS"
          SCAN_EXIT=0
      
          for DIR in "${DIRS[@]}"; do
            DIR="$(echo "$DIR" | xargs)"  # trim spaces
      
            echo ""
            echo "üîç Scanning: $DIR"
      
            if [ ! -f "$WORK_DIR/$DIR/package.json" ]; then
             echo "Skipping $DIR (no package.json)"
             continue
            fi
      
            RESULT_FILE="$WORK_DIR/scan-results-$(echo "$DIR" | tr '/.' '__').txt"
      
            if node scan.js "$WORK_DIR/$DIR" --deep --fail-on=${{ inputs.fail_on }} \
                > "$RESULT_FILE" 2>&1; then
              echo "‚úÖ Passed: $DIR"
            else
              echo "‚ùå Failed: $DIR"
              SCAN_EXIT=1
            fi
          done
      
          # Copy CSV if generated
          if [ -f "shai-hulud-report.csv" ]; then
            cp shai-hulud-report.csv "$WORK_DIR/"
            echo "üìÑ CSV report copied"
          fi
      
          echo "SCAN_EXIT_CODE=$SCAN_EXIT" >> "$GITHUB_OUTPUT"
      
          cd "$WORK_DIR"
          rm -rf "$SCAN_WORKDIR"
      
          exit $SCAN_EXIT
        

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shai-hulud-scan-results-${{ github.run_id }}
          path: |
            scan-results.txt
            shai-hulud-report.csv
          retention-days: 30
          if-no-files-found: ignore