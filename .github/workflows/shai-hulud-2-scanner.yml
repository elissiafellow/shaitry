name: Shai-Hulud 2 Scanner

on:
  workflow_call:
    inputs:
      strip_private_deps:
        description: 'Remove private git dependencies before npm install'
        required: false
        type: boolean
        default: false
      node_version:
        description: 'Node.js version to use for this repo'
        required: true
        type: string
      npm_version:
        description: 'npm version (optional)'
        required: false
        type: string
        default: ''
      scan_target:
        description: 'Directory to scan for Shai-Hulud 2 indicators'
        required: false
        type: string
        default: ''
      fail_on:
        description: 'Severity level to fail on (critical, high, medium, low)'
        required: false
        type: string
        default: 'critical'
      artifact_name_suffix:
        description: 'Suffix to make the artifact name unique per caller'
        required: false
        type: string
        default: 'default'
      scanner_version:
        description: 'Scanner version to use (commit SHA, tag, or branch). Leave empty to use latest from main branch.'
        required: false
        type: string
        default: ''

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Modify package.json (remove private deps)
        if: inputs.strip_private_deps
        run: |
          jq 'del(.devDependencies["mf-ni-wrapper"]) |
              del(.devDependencies["com.adjust.sdk"])' \
            package.json > temp.package.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}

      - name: Verify Node version
        run: |
          echo "Using Node $(node -v)"
          echo "Using npm $(npm -v)"

      - name: Setup npm (if required)
        if: inputs.npm_version != ''
        run: |
          npm install -g npm@${{ inputs.npm_version }}
          npm -v

      - name: Cache scanner
        uses: actions/cache@v4
        id: scanner-cache
        with:
          path: ~/.cache/shai-hulud-scanner
          key: shai-hulud-scanner-${{ inputs.scanner_version || 'main-latest' }}
          restore-keys: |
            shai-hulud-scanner-
      - name: Install dependencies
        run: |
          if [ "${{ inputs.strip_private_deps }}" = "true" ]; then
            mv package.json original.package.json
            mv temp.package.json package.json
          fi

          npm install

          if [ "${{ inputs.strip_private_deps }}" = "true" ]; then
            mv original.package.json package.json
          fi

      - name: Run Shai-Hulud Supply Chain Scanner
        id: scan
        run: |
          set -uo pipefail
          WORK_DIR="${{ github.workspace }}"
          SCAN_TARGET="${{ inputs.scan_target || github.workspace }}"
          SCAN_WORKDIR="$WORK_DIR/npm-scanner"
          SCANNER_CACHE="$HOME/.cache/shai-hulud-scanner"
          SCANNER_REPO="https://github.com/moneYOUnion/shai-hulud-2-scanner.git"
          SCANNER_VERSION="${{ inputs.scanner_version }}"
         
          echo "üì¶ Scanning node_modules for Shai-Hulud 2 indicators"
          echo "TARGET: $SCAN_TARGET"
          echo "WORKDIR: $SCAN_WORKDIR"
          echo "FAIL_ON: ${{ inputs.fail_on }}"
          
          mkdir -p "$SCAN_WORKDIR"
          cd "$SCAN_WORKDIR"
          
          # Use cached scanner if available
          if [ "${{ steps.scanner-cache.outputs.cache-hit }}" = "true" ]; then
            echo "‚úÖ Using cached scanner (version: ${SCANNER_VERSION:-main})"
            cp -r "$SCANNER_CACHE"/* . 2>/dev/null || {
              echo "‚ö†Ô∏è  Cache restore failed, will clone fresh"
              rm -rf "$SCAN_WORKDIR"/*
            }
          fi
          
          # Clone scanner if not cached or cache restore failed
          if [ ! -f "scan.js" ]; then
            if [ -n "$SCANNER_VERSION" ]; then
              echo "üì• Cloning scanner repository (version: $SCANNER_VERSION)"
              # Try to clone specific version (could be commit SHA, tag, or branch)
              git clone --depth 1 --branch "$SCANNER_VERSION" "$SCANNER_REPO" . 2>/dev/null || {
                # If branch/tag fails, try cloning and checking out the commit SHA
                echo "‚ö†Ô∏è  Branch/tag not found, trying as commit SHA..."
                git clone --depth 1 "$SCANNER_REPO" . || exit 1
                git fetch --depth=100 origin "$SCANNER_VERSION" 2>/dev/null || true
                git checkout "$SCANNER_VERSION" 2>/dev/null || {
                  echo "‚ùå Could not checkout version: $SCANNER_VERSION"
                  exit 1
                }
              }
            else
              echo "üì• Cloning scanner repository (latest from main branch)"
              git clone --depth 1 "$SCANNER_REPO" .
            fi
            
            # Cache the scanner for future runs
            if [ "${{ steps.scanner-cache.outputs.cache-hit }}" != "true" ]; then
              echo "üíæ Caching scanner for future runs..."
              mkdir -p "$SCANNER_CACHE"
              cp -r . "$SCANNER_CACHE/" 2>/dev/null || {
                echo "‚ö†Ô∏è  Warning: Could not cache scanner (non-fatal)"
              }
            fi
          fi
          
          # Verify scanner files exist
          if [ ! -f "scan.js" ]; then
            echo "‚ùå Scanner file 'scan.js' not found after clone/cache"
            exit 1
          fi
          
          # Log the version being used
          CURRENT_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
          echo "‚úÖ Using scanner at commit: $CURRENT_COMMIT"
          # Do the scan
          echo "üîç Running scan with --fail-on=${{ inputs.fail_on }}..."
          SCAN_OUTPUT_FILE="$WORK_DIR/scan-results.txt"
          if node scan.js "$SCAN_TARGET" --deep --fail-on=${{ inputs.fail_on }} > "$SCAN_OUTPUT_FILE" 2>&1; then
            SCAN_EXIT=0
          else
            SCAN_EXIT=$?
          fi
          # Output results
          echo ""
          echo "=== Scan Results ==="
          cat "$SCAN_OUTPUT_FILE"
          echo "===================="
          echo ""
          # Copy CSV report if it exists (scanner generates it in current directory)
          if [ -f "shai-hulud-report.csv" ]; then
            cp "shai-hulud-report.csv" "$WORK_DIR/" || echo "‚ö†Ô∏è  Could not copy CSV report (non-fatal)"
            echo "üìÑ CSV report available: shai-hulud-report.csv"
          fi
          # Set output for downstream steps
          echo "SCAN_EXIT_CODE=$SCAN_EXIT" >> $GITHUB_OUTPUT
          echo "SCAN_RESULTS_FILE=$SCAN_OUTPUT_FILE" >> $GITHUB_OUTPUT
          # Cleanup scanner workdir (keep results file and CSV)
          cd "$WORK_DIR"
          rm -rf "$SCAN_WORKDIR"
          if [ $SCAN_EXIT -ne 0 ]; then
            echo "‚ùå Scanner found issues (exit code: $SCAN_EXIT)"
            echo "   Review scan results above for details"
          else
            echo "‚úÖ Scanner passed - no ${{ inputs.fail_on }} issues found"
          fi
          exit $SCAN_EXIT

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shai-hulud-scan-results-${{ github.run_id }}
          path: |
            scan-results.txt
            shai-hulud-report.csv
          retention-days: 30
          if-no-files-found: ignore